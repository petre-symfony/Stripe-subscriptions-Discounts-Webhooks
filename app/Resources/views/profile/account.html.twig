{% extends 'base.html.twig' %}
{% block javascripts %}
  {{ parent() }}
  
  {{ include('order/_creditCardFormJavaScript.html.twig') }}
  
  <script type="text/javascript">
    jQuery(document).ready(function(){
      $('.js-open-credit-card-form').on('click', function(e){
        e.preventDefault();
        
        $('.js-update-card-wrapper').slideToggle();
      }); 
      
      $('.js-change-plan-button').on('click', function(e){
        e.preventDefault();
        
        swal('loading Plan Details');
        
        var previewUrl = $(this).data('preview-url');
        var changeUrl = $(this).data('change-url');
        var planName = $(this).data('plan-name');
        
        $.ajax({
          url: previewUrl
        }).done(function(data){
          var message;
          if (data.total > 0) {
            message = 'You will be charged $'+data.total +' immediately';
          } else {
            message = 'You will have a balance of $'+(Math.abs(data.total))+' that will be automatically applied to future invoices!';
          }
          swal({
            title: 'Change to '+planName,
            text: message,
            type: "info",
            showCancelButton: true,
            closeOnConfirm: false,
            showLoaderOnConfirm: true
          }, function () {
            $.ajax({
              url: changeUrl,
              method: 'POST'
            }).done(function(){
              swal({
                title: 'Plan changed!',
                type: 'success'
              }, function(){
                location.reload();
              })          
            });
          });
        });
      });
    });
  </script>
{% endblock %}  
{% block body %}
<div class="nav-space">
  <div class="container">
    <div class="row">
      <div class="col-xs-6">
        <h1>
          My Account
          {% if app.user.hasActiveSubscription %}
            {% if app.user.subscription.isCanceled %}
              <form action="{{ path('account_subscription_reactivate') }}" method="POST" class="pull-right">
                <button type="submit" class="btn btn-success btn-xs">Reactivate Subscription</button>
              </form>
            {% else %}  
              <form action="{{ path('account_subscription_cancel') }}" method="POST" class="pull-right">
                <button type="submit" class="btn btn-danger btn-xs">Cancel Subscription</button>
              </form>
            {% endif %}
          {% endif %}  
        </h1>
        <table class="table">
          <tbody>
            <tr>
              <th>Subscription</th>
              <td>
                {% if app.user.hasActiveSubscription %}
                  {% if app.user.subscription.isCanceled %}
                    <span class="label label-warning">Cancelled</span>
                  {% else %}  
                    {{ current_plan.name }}
                    
                    <span class="label label-success">Active</span>
                    
                    <button class="btn btn-xs btn-link pull-right js-change-plan-button"
                      data-plan-name= "{{ otherPlan.name }}"
                      data-preview-url="{{ path('account_preview_plan_change', {
                        'planId': otherPlan.planId
                      }) }}"
                      data-change-url="{{ path('account_execute_plan_change', {
                        'planId': otherPlan.planId
                      }) }}">
                        Change to {{ otherPlan.name }}
                    </button>
                  {% endif %}
                {% else %}
                   <span class="label label-default">None</span>
                {% endif %}  
              </td>
            </tr>
            <tr>
              <th>Next Billing at:</th>
              <td>
                {% if app.user.hasActiveNonCancelledSubscription %}
                  {{ app.user.subscription.billingPeriodEndsAt|date('F jS') }}
                {% else %}
                  n/a
                {% endif %}  
              </td>
            </tr>
            <tr>
              <th>Credit Card</th>
              <td>
                {% if app.user.hasActiveNonCancelledSubscription %}
                  {{ app.user.cardBrand }} ending in {{ app.user.cardLast4 }}
                  
                  <button class="btn-xs btn-link btn pull-right js-open-credit-card-form">
                    Update Card
                  </button>
                {% else %}
                  None
                {% endif %}  
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="col-xs-6">
        <div class="js-update-card-wrapper" style="display: none;">
          <h2>Update Credit Card</h2> 
          {{ include('order/_cardForm.html.twig', {
            buttonText: 'Update Card',
            formAction: path('account_update_credit_card')
          }) }}
        </div> 
      </div>       
    </div>
  </div>
</div>
{% endblock %}

